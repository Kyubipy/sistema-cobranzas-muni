<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard TV - Cobranzas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      overflow: hidden;
    }
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .nueva-actuacion {
      animation: slideIn 0.5s ease-out;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 text-white">
  
  <div class="h-screen flex flex-col p-8">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-5xl font-bold mb-2">‚öñÔ∏è COBRANZAS - MUNICIPALIDAD DE ASUNCI√ìN</h1>
        <p class="text-2xl text-purple-300">Dashboard en Tiempo Real</p>
      </div>
      <div class="text-right">
        <div id="reloj" class="text-4xl font-bold mb-2"></div>
        <div id="fecha" class="text-xl text-purple-300"></div>
        <div class="flex items-center gap-2 justify-end mt-2">
          <div class="w-3 h-3 bg-green-400 rounded-full pulse-slow"></div>
          <span class="text-sm text-green-300">Actualizaci√≥n autom√°tica</span>
        </div>
      </div>
    </div>

    <!-- M√©tricas Principales -->
    <div class="grid grid-cols-4 gap-6 mb-8">
      <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-6 shadow-2xl">
        <div class="flex items-center justify-between mb-4">
          <span class="text-6xl">üìÇ</span>
          <div class="text-right">
            <p class="text-lg opacity-90">EXPEDIENTES</p>
            <p id="totalExpedientes" class="text-6xl font-bold">0</p>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-2xl p-6 shadow-2xl">
        <div class="flex items-center justify-between mb-4">
          <span class="text-6xl">üìù</span>
          <div class="text-right">
            <p class="text-lg opacity-90">ACTUACIONES</p>
            <p id="totalActuaciones" class="text-6xl font-bold">0</p>
            <p id="actuacionesHoy" class="text-sm opacity-75 mt-1">Hoy: 0</p>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-6 shadow-2xl">
        <div class="flex items-center justify-between mb-4">
          <span class="text-6xl">üë•</span>
          <div class="text-right">
            <p class="text-lg opacity-90">ABOGADOS</p>
            <p id="totalAbogados" class="text-6xl font-bold">0</p>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl p-6 shadow-2xl">
        <div class="flex items-center justify-between mb-4">
          <span class="text-6xl">üí∞</span>
          <div class="text-right">
            <p class="text-lg opacity-90">MONTO TOTAL</p>
            <p id="montoTotal" class="text-4xl font-bold">‚Ç≤ 0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="flex-1 grid grid-cols-2 gap-6 overflow-hidden">
      
      <!-- √öltimas Actuaciones -->
      <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl overflow-hidden flex flex-col">
        <h2 class="text-3xl font-bold mb-4 flex items-center gap-3">
          <span>üïê</span>
          <span>√öLTIMAS ACTUACIONES</span>
        </h2>
        <div id="ultimasActuaciones" class="flex-1 overflow-y-auto space-y-3 pr-2">
          <!-- Se llena din√°micamente -->
        </div>
      </div>

      <!-- Ranking de Abogados -->
      <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl overflow-hidden flex flex-col">
        <h2 class="text-3xl font-bold mb-4 flex items-center gap-3">
          <span>üèÜ</span>
          <span>TOP ABOGADOS</span>
        </h2>
        <div id="rankingAbogados" class="flex-1 overflow-y-auto space-y-4">
          <!-- Se llena din√°micamente -->
        </div>
      </div>

    </div>

  </div>

  <script>
    // Configuraci√≥n de Supabase
    const SUPABASE_URL = 'https://wyxrtqudbjbwwlmqlrbc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eHJ0cXVkYmpid3dsbXFscmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTc2ODcsImV4cCI6MjA3Mzg3MzY4N30.vV0m-2D9Hod6t3CwW9ggFlgmMewlF0SaeuC2horX8fs';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let expedientes = [];
    let actuaciones = [];
    let ultimasActuacionesIds = new Set();

    // Actualizar reloj
    function actualizarReloj() {
      const ahora = new Date();
      const horas = ahora.getHours().toString().padStart(2, '0');
      const minutos = ahora.getMinutes().toString().padStart(2, '0');
      const segundos = ahora.getSeconds().toString().padStart(2, '0');
      
      document.getElementById('reloj').textContent = `${horas}:${minutos}:${segundos}`;
      
      const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      const fecha = `${dias[ahora.getDay()]}, ${ahora.getDate()} de ${meses[ahora.getMonth()]} de ${ahora.getFullYear()}`;
      document.getElementById('fecha').textContent = fecha;
    }

    // Cargar datos
    async function cargarDatos() {
      try {
        // Cargar expedientes
        const { data: exps, error: expError } = await supabase
          .from('expedientes_cobranzas')
          .select('*')
          .order('fecha_creacion', { ascending: false });
        
        if (expError) throw expError;
        expedientes = exps || [];

        // Cargar actuaciones
        const { data: acts, error: actError } = await supabase
          .from('actuaciones_cobranzas')
          .select('*')
          .order('fecha_registro', { ascending: false })
          .limit(20);
        
        if (actError) throw actError;
        
        // Detectar nuevas actuaciones
        const nuevasIds = new Set(acts.map(a => a.id));
        const hayNuevas = acts.some(a => !ultimasActuacionesIds.has(a.id));
        
        actuaciones = acts || [];
        ultimasActuacionesIds = nuevasIds;

        actualizarDashboard(hayNuevas);
      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }

    // Actualizar dashboard
    function actualizarDashboard(hayNuevas = false) {
      // M√©tricas
      const totalExpedientes = expedientes.length;
      const totalActuaciones = actuaciones.length;
      const abogadosActivos = new Set(expedientes.map(e => e.abogado_responsable)).size;
      const montoTotal = expedientes.filter(e => e.tiene_monto).reduce((sum, e) => sum + (parseFloat(e.monto) || 0), 0);
      
      // Actuaciones de hoy
      const hoy = new Date().toDateString();
      const actuacionesHoy = actuaciones.filter(a => new Date(a.fecha_actuacion).toDateString() === hoy);

      document.getElementById('totalExpedientes').textContent = totalExpedientes;
      document.getElementById('totalActuaciones').textContent = totalActuaciones;
      document.getElementById('actuacionesHoy').textContent = `Hoy: ${actuacionesHoy.length}`;
      document.getElementById('totalAbogados').textContent = abogadosActivos;
      document.getElementById('montoTotal').textContent = `‚Ç≤ ${montoTotal.toLocaleString('es-PY')}`;

      // √öltimas actuaciones
      const ultimasDiv = document.getElementById('ultimasActuaciones');
      ultimasDiv.innerHTML = actuaciones.slice(0, 10).map((act, index) => {
        const expediente = expedientes.find(e => e.id === act.expediente_cobranza_id);
        const tiempo = calcularTiempoTranscurrido(act.fecha_registro);
        const esNueva = index === 0 && hayNuevas;
        
        return `
          <div class="${esNueva ? 'nueva-actuacion' : ''} bg-gradient-to-r from-indigo-600/80 to-purple-600/80 rounded-xl p-4 backdrop-blur border border-white/20">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="text-2xl">üìù</span>
                <span class="font-bold text-xl">${act.abogado}</span>
              </div>
              <span class="text-sm bg-white/20 px-2 py-1 rounded">${tiempo}</span>
            </div>
            ${expediente ? `
              <p class="text-lg font-semibold mb-1">üìÇ Expte. ${expediente.num_expediente}/${expediente.anio}</p>
            ` : ''}
            <p class="text-sm opacity-90">${act.descripcion_actuacion}</p>
          </div>
        `;
      }).join('');

      // Ranking de abogados
      const porAbogado = {};
      expedientes.forEach(exp => {
        porAbogado[exp.abogado_responsable] = (porAbogado[exp.abogado_responsable] || 0) + 1;
      });
      
      const topAbogados = Object.entries(porAbogado)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

      const rankingDiv = document.getElementById('rankingAbogados');
      const medallas = ['ü•á', 'ü•à', 'ü•â'];
      const colores = [
        'from-yellow-400 to-yellow-600',
        'from-gray-300 to-gray-500',
        'from-orange-400 to-orange-600',
        'from-blue-400 to-blue-600',
        'from-green-400 to-green-600',
        'from-purple-400 to-purple-600',
        'from-pink-400 to-pink-600',
        'from-red-400 to-red-600'
      ];

      rankingDiv.innerHTML = topAbogados.map(([abogado, count], index) => `
        <div class="bg-gradient-to-r ${colores[index]} rounded-xl p-4 shadow-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-4xl">${medallas[index] || 'üèÖ'}</span>
              <div>
                <p class="font-bold text-xl">${abogado}</p>
                <p class="text-sm opacity-90">${count} expediente${count !== 1 ? 's' : ''}</p>
              </div>
            </div>
            <span class="text-5xl font-bold">${count}</span>
          </div>
        </div>
      `).join('');
    }

    function calcularTiempoTranscurrido(fecha) {
      const ahora = new Date();
      const registro = new Date(fecha);
      const diff = ahora - registro;
      
      const minutos = Math.floor(diff / 60000);
      const horas = Math.floor(minutos / 60);
      const dias = Math.floor(horas / 24);
      
      if (dias > 0) return `hace ${dias}d`;
      if (horas > 0) return `hace ${horas}h`;
      if (minutos > 0) return `hace ${minutos}m`;
      return 'ahora';
    }

    // Inicializar
    actualizarReloj();
    setInterval(actualizarReloj, 1000);

    cargarDatos();
    setInterval(cargarDatos, 30000); // Actualizar cada 30 segundos

    // Suscripci√≥n en tiempo real para actualizaciones instant√°neas
    supabase
      .channel('tv_dashboard')
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'expedientes_cobranzas' },
        () => cargarDatos()
      )
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'actuaciones_cobranzas' },
        () => cargarDatos()
      )
      .subscribe();
  </script>

</body>
</html>