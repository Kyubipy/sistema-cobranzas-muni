<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Cobranzas - Abogados</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="app">
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Cargando...</p>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Supabase
    const SUPABASE_URL = 'https://wyxrtqudbjbwwlmqlrbc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eHJ0cXVkYmpid3dsbXFscmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTc2ODcsImV4cCI6MjA3Mzg3MzY4N30.vV0m-2D9Hod6t3CwW9ggFlgmMewlF0SaeuC2horX8fs';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variables globales
    let expedientes = [];
    let actuaciones = [];
    let vistaActual = 'formulario';
    let usuarioActual = null;
    let expedienteSeleccionado = null;
    let expedientesExistentes = [];
    let guardando = false;

    async function init() {
      console.log('Iniciando aplicaci√≥n...');
      
      // Verificar si hay usuario logueado
      const usuarioGuardado = localStorage.getItem('usuarioActual');
      if (!usuarioGuardado) {
        window.location.href = 'index.html';
        return;
      }

      usuarioActual = JSON.parse(usuarioGuardado);
      
      // Verificar que sea abogado
      if (usuarioActual.rol !== 'abogado') {
        alert('Acceso no autorizado');
        localStorage.removeItem('usuarioActual');
        window.location.href = 'index.html';
        return;
      }

      await cargarExpedientesExistentes();
      await cargarMisExpedientes();
      renderApp();
      suscribirTiempoReal();
    }

    async function cargarExpedientesExistentes() {
      try {
        const { data, error } = await supabase
          .from('expedientes_cobranzas')
          .select('id, num_expediente, anio, caratula, juzgado, turno, secretaria')
          .eq('abogado_responsable', usuarioActual.nombre_completo)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        expedientesExistentes = data || [];
        console.log('Expedientes para selector:', expedientesExistentes.length);
        actualizarSelectorExpedientes();
      } catch (error) {
        console.error('Error cargando expedientes:', error);
      }
    }

    function actualizarSelectorExpedientes() {
      const selector = document.querySelector('select[name="expedienteExistente"]');
      if (selector) {
        const valorActual = selector.value;
        selector.innerHTML = `
          <option value="">-- Seleccione un expediente --</option>
          ${expedientesExistentes.map(exp => `
            <option value="${exp.id}">
              Expte ${exp.num_expediente}/${exp.anio} - ${exp.caratula}${exp.juzgado ? ' - ' + exp.juzgado : ''}
            </option>
          `).join('')}
        `;
        selector.value = valorActual;
      }
    }

    async function cargarMisExpedientes() {
      try {
        const { data: exps, error: expError } = await supabase
          .from('expedientes_cobranzas')
          .select('*')
          .eq('abogado_responsable', usuarioActual.nombre_completo)
          .order('fecha_creacion', { ascending: false });
        
        if (expError) throw expError;
        expedientes = exps || [];

        if (expedientes.length > 0) {
          const expedienteIds = expedientes.map(e => e.id);
          const { data: acts, error: actError } = await supabase
            .from('actuaciones_cobranzas')
            .select('*')
            .in('expediente_cobranza_id', expedienteIds)
            .order('fecha_actuacion', { ascending: false });
          
          if (actError) throw actError;
          actuaciones = acts || [];
        }

        if (vistaActual === 'historial') renderHistorial();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar datos: ' + error.message);
      }
    }

    function suscribirTiempoReal() {
      supabase
        .channel('cobranzas_channel')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'expedientes_cobranzas' },
          (payload) => {
            console.log('Cambio en expedientes:', payload);
            cargarExpedientesExistentes();
            cargarMisExpedientes();
          }
        )
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'actuaciones_cobranzas' },
          (payload) => {
            console.log('Cambio en actuaciones:', payload);
            cargarMisExpedientes();
          }
        )
        .subscribe();
    }

    async function subirArchivo(file) {
      const fileName = `${Date.now()}_${file.name}`;
      
      const { data, error } = await supabase.storage
        .from('actuaciones')
        .upload(fileName, file);
      
      if (error) {
        console.error('Error subiendo archivo:', error);
        throw error;
      }

      const { data: urlData } = supabase.storage
        .from('actuaciones')
        .getPublicUrl(fileName);
      
      console.log('Archivo subido:', fileName, 'URL:', urlData.publicUrl);
      
      return { nombre: file.name, url: urlData.publicUrl };
    }

    async function guardarActuacion(event) {
      event.preventDefault();
      
      if (guardando) {
        console.log('Ya hay un guardado en proceso...');
        return;
      }
      
      guardando = true;
      
      const form = event.target;
      const formData = new FormData(form);
      const tipoRegistro = formData.get('tipoRegistro');
      const archivo = formData.get('archivo');
      
      const boton = document.getElementById('btnGuardar');
      const textoOriginal = boton.innerHTML;
      
      boton.disabled = true;
      boton.classList.add('opacity-50', 'cursor-not-allowed');
      boton.innerHTML = `
        <div class="flex items-center justify-center gap-3">
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Guardando actuaci√≥n...</span>
        </div>
      `;

      try {
        let expedienteId;

        if (tipoRegistro === 'nuevo') {
          if (!formData.get('numExpediente') || !formData.get('caratula')) {
            alert('Complete n√∫mero de expediente y car√°tula');
            return;
          }

          const tieneMonto = formData.get('tieneMonto') === 'on';
          if (tieneMonto && !formData.get('monto')) {
            alert('Ingrese el monto del juicio');
            return;
          }

          const { data: nuevoExp, error: expError } = await supabase
            .from('expedientes_cobranzas')
            .insert([{
              num_expediente: formData.get('numExpediente'),
              anio: formData.get('anio'),
              caratula: formData.get('caratula'),
              juzgado: formData.get('juzgado') || null,
              turno: formData.get('turno') || null,
              secretaria: formData.get('secretaria') || null,
              tiene_monto: tieneMonto,
              monto: tieneMonto ? parseFloat(formData.get('monto')) || 0 : 0,
              abogado_responsable: usuarioActual.nombre_completo
            }])
            .select()
            .single();
          
          if (expError) throw expError;
          expedienteId = nuevoExp.id;
          
          console.log('Nuevo expediente creado:', expedienteId);
          await cargarExpedientesExistentes();
        } else {
          expedienteId = parseInt(formData.get('expedienteExistente'));
          if (!expedienteId) {
            alert('Seleccione un expediente');
            return;
          }
        }

        if (!formData.get('fechaActuacion') || !formData.get('descripcionActuacion')) {
          alert('Complete fecha y descripci√≥n de la actuaci√≥n');
          return;
        }

        let archivoData = { nombre: null, url: null };
        if (archivo && archivo.size > 0) {
          console.log('Subiendo archivo:', archivo.name);
          
          const actExpediente = actuaciones.filter(a => a.expediente_cobranza_id === expedienteId);
          const archivoExiste = actExpediente.some(a => a.archivo_nombre === archivo.name);
          
          if (archivoExiste) {
            const confirmar = confirm(`‚ö†Ô∏è Ya existe un archivo llamado "${archivo.name}" en este expediente.\n\n¬øQuer√©s subirlo de todas formas?`);
            if (!confirmar) {
              return;
            }
          }
          
          archivoData = await subirArchivo(archivo);
        }

        const { error: actError } = await supabase
          .from('actuaciones_cobranzas')
          .insert([{
            expediente_cobranza_id: expedienteId,
            abogado: usuarioActual.nombre_completo,
            fecha_actuacion: formData.get('fechaActuacion'),
            descripcion_actuacion: formData.get('descripcionActuacion'),
            archivo_url: archivoData.url,
            archivo_nombre: archivoData.nombre,
            observaciones: formData.get('observaciones') || ''
          }]);
        
        if (actError) throw actError;

        alert('‚úÖ Actuaci√≥n registrada exitosamente');
        form.reset();
        
        document.getElementById('camposExpedienteNuevo').style.display = 'none';
        document.getElementById('camposExpedienteExistente').style.display = 'block';
        const radioExistente = document.querySelector('input[name="tipoRegistro"][value="existente"]');
        if (radioExistente) radioExistente.checked = true;
        
        await cargarExpedientesExistentes();
        await cargarMisExpedientes();
        
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error: ' + error.message);
      } finally {
        guardando = false;
        if (boton) {
          boton.disabled = false;
          boton.classList.remove('opacity-50', 'cursor-not-allowed');
          boton.innerHTML = textoOriginal;
        }
      }
    }

    function cambiarVista(vista) {
      vistaActual = vista;
      renderApp();
    }

    function cambiarTipoRegistro(tipo) {
      if (tipo === 'nuevo') {
        document.getElementById('camposExpedienteNuevo').style.display = 'block';
        document.getElementById('camposExpedienteExistente').style.display = 'none';
        const resumen = document.getElementById('resumenActuaciones');
        if (resumen) resumen.style.display = 'none';
      } else {
        document.getElementById('camposExpedienteNuevo').style.display = 'none';
        document.getElementById('camposExpedienteExistente').style.display = 'block';
      }
    }

    function mostrarActuacionesExpediente(expedienteId) {
      const resumen = document.getElementById('resumenActuaciones');
      const lista = document.getElementById('listaActuaciones');
      
      if (!expedienteId || !resumen || !lista) {
        if (resumen) resumen.style.display = 'none';
        return;
      }

      const actsExp = actuaciones.filter(a => a.expediente_cobranza_id === parseInt(expedienteId))
        .sort((a, b) => new Date(b.fecha_actuacion) - new Date(a.fecha_actuacion));

      if (actsExp.length === 0) {
        resumen.style.display = 'block';
        lista.innerHTML = '<p class="text-sm text-gray-600 italic">Este expediente no tiene actuaciones registradas a√∫n.</p>';
        return;
      }

      resumen.style.display = 'block';
      lista.innerHTML = actsExp.map((act, index) => `
        <div class="bg-white border-l-4 border-blue-500 rounded p-3 text-sm">
          <div class="flex justify-between items-start mb-1">
            <span class="bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded">
              #${actsExp.length - index}
            </span>
            <span class="text-xs font-semibold text-gray-600">
              üìÖ ${new Date(act.fecha_actuacion).toLocaleDateString('es-PY')}
            </span>
          </div>
          <p class="text-gray-900 font-medium mt-1">${act.descripcion_actuacion}</p>
          ${act.archivo_nombre ? `
            <p class="text-xs text-indigo-600 mt-1">üìé ${act.archivo_nombre}</p>
          ` : ''}
        </div>
      `).join('');
    }

    function cerrarSesion() {
      if (confirm('¬øEst√°s seguro que quer√©s cerrar sesi√≥n?')) {
        localStorage.removeItem('usuarioActual');
        window.location.href = 'index.html';
      }
    }

    function renderApp() {
      const app = document.getElementById('app');
      if (!app) return;

      app.innerHTML = `
        <div class="min-h-screen">
          <div class="bg-gradient-to-r from-indigo-700 to-indigo-900 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
              <div class="flex justify-between items-center">
                <div>
                  <h1 class="text-3xl font-bold">‚öñÔ∏è Sistema de Cobranzas - Abogados</h1>
                  <p class="text-indigo-200 mt-1">Municipalidad de Asunci√≥n</p>
                </div>
                <div class="flex items-center gap-4">
                  <div class="text-right bg-white/10 px-4 py-2 rounded-lg">
                    <p class="text-sm font-semibold">üë§ ${usuarioActual.nombre_completo}</p>
                    <p class="text-xs text-indigo-200">Abogado</p>
                  </div>
                  <button onclick="cerrarSesion()" class="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition">
                    <span>üö™</span>
                    <span class="hidden sm:inline">Salir</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="bg-white rounded-lg shadow-md p-2 flex gap-2">
              <button onclick="cambiarVista('formulario')" 
                class="flex-1 py-3 px-4 rounded-md font-semibold transition-all ${
                  vistaActual === 'formulario' 
                    ? 'bg-indigo-600 text-white shadow-lg' 
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }">
                üìù Registrar Actuaci√≥n
              </button>
              <button onclick="cambiarVista('historial')" 
                class="flex-1 py-3 px-4 rounded-md font-semibold transition-all ${
                  vistaActual === 'historial' 
                    ? 'bg-indigo-600 text-white shadow-lg' 
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }">
                üìö Mi Historial
              </button>
            </div>
          </div>

          <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="contenido"></div>
          </div>
        </div>
      `;

      if (vistaActual === 'formulario') {
        renderFormulario();
      } else {
        renderHistorial();
      }
    }

    function renderFormulario() {
      document.getElementById('contenido').innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Registrar Nueva Actuaci√≥n</h2>
          
          <form id="formActuacion" class="space-y-5">
            
            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                ¬øEs un expediente nuevo o agreg√°s actuaci√≥n a uno existente?
              </label>
              <div class="flex gap-4">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="tipoRegistro" value="existente" checked
                    onchange="cambiarTipoRegistro('existente')"
                    class="w-4 h-4 text-indigo-600 mr-2">
                  <span class="text-sm font-medium">Expediente Existente</span>
                </label>
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="tipoRegistro" value="nuevo"
                    onchange="cambiarTipoRegistro('nuevo')"
                    class="w-4 h-4 text-indigo-600 mr-2">
                  <span class="text-sm font-medium">Expediente Nuevo</span>
                </label>
              </div>
            </div>

            <div id="camposExpedienteExistente" class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Seleccionar Expediente <span class="text-red-500">*</span>
                </label>
                <select name="expedienteExistente" onchange="mostrarActuacionesExpediente(this.value)"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                  <option value="">-- Seleccione un expediente --</option>
                  ${expedientesExistentes.map(exp => `
                    <option value="${exp.id}">
                      Expte ${exp.num_expediente}/${exp.anio} - ${exp.caratula}${exp.juzgado ? ' - ' + exp.juzgado : ''}
                    </option>
                  `).join('')}
                </select>
              </div>
              
              <div id="resumenActuaciones" style="display: none;" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                  <span>üìã</span>
                  <span>Actuaciones registradas en este expediente:</span>
                </h4>
                <div id="listaActuaciones" class="space-y-2 max-h-60 overflow-y-auto"></div>
              </div>
            </div>

            <div id="camposExpedienteNuevo" style="display: none;" class="space-y-4 bg-green-50 p-4 rounded-lg">
              <h3 class="font-bold text-green-800">üìÇ Datos del Nuevo Expediente</h3>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    N¬∞ Expediente <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="numExpediente"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    A√±o <span class="text-red-500">*</span>
                  </label>
                  <input type="text" name="anio" value="${new Date().getFullYear()}"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Car√°tula <span class="text-red-500">*</span>
                </label>
                <input type="text" name="caratula"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="Municipalidad c/ Contribuyente s/ Cobro">
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üèõÔ∏è Juzgado
                  </label>
                  <input type="text" name="juzgado"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Juzgado de Primera Instancia">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üîÑ Turno
                  </label>
                  <select name="turno" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">-- Seleccionar --</option>
                    ${Array.from({length: 100}, (_, i) => i + 1).map(n => `<option value="Turno ${n}">Turno ${n}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üìã Secretar√≠a
                  </label>
                  <select name="secretaria" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">-- Seleccionar --</option>
                    ${Array.from({length: 100}, (_, i) => i + 1).map(n => `<option value="Secretar√≠a N¬∞ ${n}">Secretar√≠a N¬∞ ${n}</option>`).join('')}
                  </select>
                </div>
              </div>

              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <label class="flex items-center cursor-pointer">
                  <input type="checkbox" name="tieneMonto" checked
                    onchange="document.getElementById('montoInputNuevo').style.display = this.checked ? 'block' : 'none'"
                    class="w-4 h-4 text-indigo-600 border-gray-300 rounded mr-3">
                  <span class="text-sm font-semibold text-gray-700">El juicio tiene monto determinado</span>
                </label>
                <div id="montoInputNuevo" class="mt-3">
                  <input type="number" name="monto" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    placeholder="Monto en Guaran√≠es (‚Ç≤)">
                </div>
              </div>
            </div>

            <div class="bg-purple-50 p-4 rounded-lg space-y-4">
              <h3 class="font-bold text-purple-800">üìù Datos de la Actuaci√≥n</h3>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Fecha de la Actuaci√≥n <span class="text-red-500">*</span>
                </label>
                <input type="date" name="fechaActuacion" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Descripci√≥n de la Actuaci√≥n <span class="text-red-500">*</span>
                </label>
                <textarea name="descripcionActuacion" rows="4" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="Describa detalladamente la actuaci√≥n realizada..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  üìé Archivo de la Actuaci√≥n <span class="text-red-500">*</span>
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-indigo-400 transition-colors text-center">
                  <input type="file" name="archivo" required
                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                    class="w-full text-sm text-gray-600">
                  <p class="text-xs text-gray-500 mt-2">üìÑ PDF, DOC, DOCX, JPG o PNG (m√°x. 10MB) - OBLIGATORIO</p>
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Observaciones
                </label>
                <textarea name="observaciones" rows="3"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="Observaciones adicionales (opcional)..."></textarea>
              </div>
            </div>

            <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4">
              <div class="flex items-start">
                <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                <div>
                  <p class="text-sm font-semibold text-yellow-800">Importante</p>
                  <p class="text-sm text-yellow-700 mt-1">
                    Las actuaciones registradas no pueden ser eliminadas y quedar√°n en el historial permanente.
                  </p>
                </div>
              </div>
            </div>

            <button type="submit" id="btnGuardar"
              class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-4 rounded-lg font-bold text-lg hover:from-indigo-700 hover:to-indigo-800 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
              ‚úÖ Registrar Actuaci√≥n
            </button>
          </form>
        </div>
      `;

      document.getElementById('formActuacion').addEventListener('submit', guardarActuacion);
    }

    function renderHistorial() {
      document.getElementById('contenido').innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">üìö Mi Historial de Expedientes</h2>
          
          ${expedientes.length === 0 ? `
            <div class="text-center py-12 text-gray-500">
              <p class="text-xl">üî≠ No ten√©s expedientes registrados</p>
              <p class="text-sm mt-2">Comenz√° registrando tu primera actuaci√≥n</p>
            </div>
          ` : `
            <div class="space-y-6">
              ${expedientes.map(exp => {
                const actExp = actuaciones.filter(a => a.expediente_cobranza_id === exp.id)
                  .sort((a, b) => new Date(b.fecha_actuacion) - new Date(a.fecha_actuacion));
                
                return `
                  <div class="border-2 border-indigo-200 rounded-xl p-5 bg-gradient-to-r from-white to-indigo-50">
                    <div class="flex justify-between items-start mb-4">
                      <div>
                        <h3 class="text-xl font-bold text-gray-900">
                          üìÇ Expte. ${exp.num_expediente}/${exp.anio}
                        </h3>
                        <p class="text-gray-700 font-semibold mt-1">${exp.caratula}</p>
                        ${exp.juzgado || exp.turno || exp.secretaria ? `
                          <div class="flex gap-3 mt-2 text-sm text-gray-600">
                            ${exp.juzgado ? `<span class="bg-blue-100 px-2 py-1 rounded">üèõÔ∏è ${exp.juzgado}</span>` : ''}
                            ${exp.turno ? `<span class="bg-green-100 px-2 py-1 rounded">üîÑ ${exp.turno}</span>` : ''}
                            ${exp.secretaria ? `<span class="bg-purple-100 px-2 py-1 rounded">üìã ${exp.secretaria}</span>` : ''}
                          </div>
                        ` : ''}
                        ${exp.tiene_monto && exp.monto > 0 ? `
                          <p class="text-green-700 font-bold text-lg mt-2">
                            üí∞ ‚Ç≤ ${parseFloat(exp.monto).toLocaleString('es-PY')}
                          </p>
                        ` : ''}
                      </div>
                      <span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                        ${actExp.length} actuaci√≥n${actExp.length !== 1 ? 'es' : ''}
                      </span>
                    </div>

                    <div class="mt-4 border-t-2 border-indigo-200 pt-4">
                      <h4 class="font-bold text-indigo-800 mb-3">üìù HISTORIAL DE ACTUACIONES:</h4>
                      ${actExp.length === 0 ? `
                        <p class="text-gray-500 text-sm italic">Sin actuaciones registradas</p>
                      ` : `
                        <div class="space-y-3">
                          ${actExp.map((act, index) => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                              <div class="flex justify-between items-start mb-2">
                                <span class="bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded">
                                  #${actExp.length - index}
                                </span>
                                <span class="text-sm font-semibold text-gray-600">
                                  üìÖ ${new Date(act.fecha_actuacion).toLocaleDateString('es-PY')}
                                </span>
                              </div>
                              
                              <p class="text-gray-900 font-medium mb-2">${act.descripcion_actuacion}</p>
                              
                              ${act.observaciones ? `
                                <p class="text-sm text-gray-600 italic mb-2">
                                  üí≠ ${act.observaciones}
                                </p>
                              ` : ''}
                              
                              ${act.archivo_nombre ? `
                                <a href="${act.archivo_url}" target="_blank" rel="noopener noreferrer"
                                  class="flex items-center gap-2 text-indigo-700 hover:text-indigo-900 font-semibold text-sm bg-indigo-50 hover:bg-indigo-100 px-3 py-2 rounded transition-colors">
                                  <span class="text-lg">üìé</span>
                                  <span class="flex-1">${act.archivo_nombre}</span>
                                  <span class="text-xs text-indigo-600">‚ÜóÔ∏è</span>
                                </a>
                              ` : ''}
                              
                              <p class="text-xs text-gray-400 mt-2">
                                ‚è∞ Registrado: ${new Date(act.fecha_registro).toLocaleString('es-PY')}
                              </p>
                            </div>
                          `).join('')}
                        </div>
                      `}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}
        </div>
      `;
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(init, 200);
      });
    } else {
      setTimeout(init, 200);
    }
  </script>
</body>
</html>
