<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Abogado - Sistema de Cobranzas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  
  <!-- Header con usuario y cerrar sesión -->
  <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <span class="text-3xl">⚖️</span>
          <div>
            <h1 class="text-xl font-bold">Sistema de Cobranzas</h1>
            <p class="text-sm text-purple-100">Municipalidad de Asunción</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <div class="flex items-center gap-2">
              <span>👤</span>
              <span id="nombreUsuario" class="font-semibold"></span>
            </div>
            <div class="text-xs text-purple-100" id="areaUsuario"></div>
          </div>
          <button onclick="cerrarSesion()" class="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
            <span>🚪</span>
            <span class="hidden sm:inline">Salir</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8">
    <!-- Formulario de registro de actuación -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        <span>📝</span> Registrar Actuación Judicial
      </h2>
      
      <form id="actuacionForm" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Seleccionar o crear expediente -->
          <div class="md:col-span-2">
            <label class="block text-gray-700 font-semibold mb-2">
              🗂️ Expediente
            </label>
            <div class="flex gap-2">
              <select 
                id="expedienteExistente" 
                class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
              >
                <option value="">Nuevo expediente...</option>
              </select>
              <button 
                type="button"
                id="btnNuevoExpediente"
                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
              >
                ➕ Nuevo
              </button>
            </div>
          </div>

          <!-- Campos para nuevo expediente (ocultos por defecto) -->
          <div id="camposNuevoExpediente" class="md:col-span-2 hidden space-y-4 bg-green-50 p-4 rounded-lg border-2 border-green-200">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Número de Expediente</label>
                <input 
                  type="text" 
                  id="numeroExpediente" 
                  placeholder="Ej: 2024-001"
                  class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                >
              </div>
              <div>
                <label class="block text-gray-700 font-semibold mb-2">Monto Reclamado (Gs.)</label>
                <input 
                  type="number" 
                  id="montoReclamado" 
                  placeholder="0"
                  class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                >
              </div>
            </div>
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Descripción del Caso</label>
              <textarea 
                id="descripcionCaso" 
                rows="2"
                placeholder="Breve descripción del caso..."
                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
              ></textarea>
            </div>
          </div>

          <!-- Historial del expediente seleccionado -->
          <div id="historialExpediente" class="md:col-span-2 hidden bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
            <h3 class="font-bold text-blue-800 mb-2">📋 Historial del Expediente</h3>
            <div id="listaHistorial" class="space-y-2 text-sm text-gray-700"></div>
          </div>

          <!-- Tipo de actuación -->
          <div>
            <label class="block text-gray-700 font-semibold mb-2">⚖️ Tipo de Actuación</label>
            <select 
              id="tipoActuacion" 
              required
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
            >
              <option value="">Seleccionar...</option>
              <option value="Demanda">Demanda</option>
              <option value="Contestación">Contestación</option>
              <option value="Audiencia">Audiencia</option>
              <option value="Sentencia">Sentencia</option>
              <option value="Recurso">Recurso</option>
              <option value="Ejecución">Ejecución</option>
              <option value="Trámite">Trámite</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <!-- Fecha de actuación -->
          <div>
            <label class="block text-gray-700 font-semibold mb-2">📅 Fecha</label>
            <input 
              type="date" 
              id="fechaActuacion" 
              required
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
            >
          </div>

          <!-- Descripción -->
          <div class="md:col-span-2">
            <label class="block text-gray-700 font-semibold mb-2">📄 Descripción</label>
            <textarea 
              id="descripcionActuacion" 
              required
              rows="3"
              placeholder="Describe la actuación realizada..."
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
            ></textarea>
          </div>

          <!-- Adjuntar archivo -->
          <div class="md:col-span-2">
            <label class="block text-gray-700 font-semibold mb-2">📎 Adjuntar Documento (opcional)</label>
            <input 
              type="file" 
              id="archivoActuacion" 
              accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
            >
            <p class="text-sm text-gray-500 mt-1">Formatos: PDF, Word, Imágenes (máx. 5MB)</p>
          </div>
        </div>

        <!-- Mensajes -->
        <div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded text-red-700"></div>
        <div id="successMessage" class="hidden bg-green-50 border-l-4 border-green-500 p-4 rounded text-green-700"></div>

        <!-- Botones -->
        <div class="flex gap-4">
          <button 
            type="submit"
            id="btnGuardar"
            class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-indigo-700 transition"
          >
            💾 Guardar Actuación
          </button>
          <button 
            type="button"
            onclick="limpiarFormulario()"
            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition"
          >
            🔄 Limpiar
          </button>
        </div>
      </form>
    </div>

    <!-- Lista de actuaciones recientes -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <span>📊</span> Mis Actuaciones Recientes
      </h2>
      <div id="listaActuaciones" class="space-y-3">
        <p class="text-gray-500 text-center py-8">Cargando actuaciones...</p>
      </div>
    </div>
  </div>

  <script>
    // Configuración de Supabase
    const supabaseUrl = 'https://wyxrtqudbjbwwlmqlrbc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eHJ0cXVkYmpid3dsbXFscmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTc2ODcsImV4cCI6MjA3Mzg3MzY4N30.vV0m-2D9Hod6t3CwW9ggFlgmMewlF0SaeuC2horX8fs';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let usuarioActual = null;

    // Verificar sesión al cargar
    window.addEventListener('DOMContentLoaded', () => {
      const usuarioGuardado = localStorage.getItem('usuarioActual');
      if (!usuarioGuardado) {
        window.location.href = 'index.html';
        return;
      }
      
      usuarioActual = JSON.parse(usuarioGuardado);
      
      // Verificar que sea abogado
      if (usuarioActual.rol !== 'abogado') {
        alert('Acceso no autorizado');
        localStorage.removeItem('usuarioActual');
        window.location.href = 'index.html';
        return;
      }

      // Mostrar info del usuario
      document.getElementById('nombreUsuario').textContent = usuarioActual.nombre_completo;
      document.getElementById('areaUsuario').textContent = usuarioActual.area;

      // Establecer fecha de hoy
      document.getElementById('fechaActuacion').valueAsDate = new Date();

      // Cargar expedientes y actuaciones
      cargarExpedientes();
      cargarActuaciones();
      suscribirCambios();
    });

    // Función para cerrar sesión
    function cerrarSesion() {
      if (confirm('¿Estás seguro que querés cerrar sesión?')) {
        localStorage.removeItem('usuarioActual');
        window.location.href = 'index.html';
      }
    }

    // Toggle nuevo expediente
    document.getElementById('btnNuevoExpediente').addEventListener('click', () => {
      const campos = document.getElementById('camposNuevoExpediente');
      const select = document.getElementById('expedienteExistente');
      
      if (campos.classList.contains('hidden')) {
        campos.classList.remove('hidden');
        select.value = '';
        select.disabled = true;
        document.getElementById('historialExpediente').classList.add('hidden');
      } else {
        campos.classList.add('hidden');
        select.disabled = false;
      }
    });

    // Cargar expedientes del abogado
    async function cargarExpedientes() {
      try {
        const { data, error } = await supabase
          .from('expedientes_cobranzas')
          .select('*')
          .eq('usuario_id', usuarioActual.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        const select = document.getElementById('expedienteExistente');
        select.innerHTML = '<option value="">Nuevo expediente...</option>';
        
        data.forEach(exp => {
          const option = document.createElement('option');
          option.value = exp.id;
          option.textContent = `${exp.numero_expediente} - ${exp.descripcion_caso}`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error al cargar expedientes:', error);
      }
    }

    // Mostrar historial al seleccionar expediente
    document.getElementById('expedienteExistente').addEventListener('change', async (e) => {
      const expedienteId = e.target.value;
      const historialDiv = document.getElementById('historialExpediente');
      const listaHistorial = document.getElementById('listaHistorial');

      if (!expedienteId) {
        historialDiv.classList.add('hidden');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('actuaciones_cobranzas')
          .select('*')
          .eq('expediente_id', expedienteId)
          .order('fecha_actuacion', { ascending: false });

        if (error) throw error;

        if (data.length > 0) {
          listaHistorial.innerHTML = data.map(act => `
            <div class="p-2 bg-white rounded border border-blue-300">
              <strong>${new Date(act.fecha_actuacion).toLocaleDateString()}</strong> - ${act.tipo_actuacion}: ${act.descripcion}
            </div>
          `).join('');
          historialDiv.classList.remove('hidden');
        } else {
          historialDiv.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error al cargar historial:', error);
      }
    });

    // Enviar formulario
    let procesando = false;
    document.getElementById('actuacionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (procesando) return;
      procesando = true;

      const errorDiv = document.getElementById('errorMessage');
      const successDiv = document.getElementById('successMessage');
      const boton = document.getElementById('btnGuardar');
      const textoOriginal = boton.innerHTML;

      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');

      boton.disabled = true;
      boton.innerHTML = '⏳ Guardando...';

      try {
        let expedienteId;
        const expedienteExistente = document.getElementById('expedienteExistente').value;
        
        // Crear nuevo expediente si es necesario
        if (!expedienteExistente) {
          const numeroExp = document.getElementById('numeroExpediente').value.trim();
          const montoExp = document.getElementById('montoReclamado').value;
          const descripcionExp = document.getElementById('descripcionCaso').value.trim();

          if (!numeroExp || !descripcionExp) {
            throw new Error('Completá todos los campos del nuevo expediente');
          }

          const { data: nuevoExp, error: errorExp } = await supabase
            .from('expedientes_cobranzas')
            .insert([{
              numero_expediente: numeroExp,
              descripcion_caso: descripcionExp,
              monto_reclamado: montoExp || 0,
              abogado_responsable: usuarioActual.nombre_completo,
              usuario_id: usuarioActual.id,
              area: usuarioActual.area,
              estado: 'Activo'
            }])
            .select()
            .single();

          if (errorExp) throw errorExp;
          expedienteId = nuevoExp.id;
        } else {
          expedienteId = expedienteExistente;
        }

        // Subir archivo si existe
        let archivoUrl = null;
        const archivoInput = document.getElementById('archivoActuacion');
        if (archivoInput.files.length > 0) {
          const archivo = archivoInput.files[0];
          const nombreArchivo = `${Date.now()}_${archivo.name}`;
          
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('documentos-cobranzas')
            .upload(nombreArchivo, archivo);

          if (uploadError) throw uploadError;

          const { data: urlData } = supabase.storage
            .from('documentos-cobranzas')
            .getPublicUrl(nombreArchivo);
          
          archivoUrl = urlData.publicUrl;
        }

        // Crear actuación
        const { error: errorActuacion } = await supabase
          .from('actuaciones_cobranzas')
          .insert([{
            expediente_id: expedienteId,
            tipo_actuacion: document.getElementById('tipoActuacion').value,
            fecha_actuacion: document.getElementById('fechaActuacion').value,
            descripcion: document.getElementById('descripcionActuacion').value.trim(),
            abogado: usuarioActual.nombre_completo,
            usuario_id: usuarioActual.id,
            archivo_url: archivoUrl
          }]);

        if (errorActuacion) throw errorActuacion;

        successDiv.textContent = '✅ Actuación registrada exitosamente';
        successDiv.classList.remove('hidden');

        limpiarFormulario();
        await cargarExpedientes();
        await cargarActuaciones();

      } catch (error) {
        errorDiv.textContent = '⚠️ ' + error.message;
        errorDiv.classList.remove('hidden');
      } finally {
        boton.disabled = false;
        boton.innerHTML = textoOriginal;
        procesando = false;
      }
    });

    // Cargar actuaciones del abogado
    async function cargarActuaciones() {
      try {
        const { data, error } = await supabase
          .from('actuaciones_cobranzas')
          .select(`
            *,
            expedientes_cobranzas (numero_expediente, descripcion_caso)
          `)
          .eq('usuario_id', usuarioActual.id)
          .order('fecha_actuacion', { ascending: false })
          .limit(20);

        if (error) throw error;

        const lista = document.getElementById('listaActuaciones');
        
        if (data.length === 0) {
          lista.innerHTML = '<p class="text-gray-500 text-center py-8">No hay actuaciones registradas aún</p>';
          return;
        }

        lista.innerHTML = data.map(act => `
          <div class="border-l-4 border-purple-500 bg-gray-50 p-4 rounded-r-lg hover:bg-gray-100 transition">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-bold text-purple-600">${act.expedientes_cobranzas.numero_expediente}</span>
                  <span class="text-sm text-gray-500">${new Date(act.fecha_actuacion).toLocaleDateString()}</span>
                </div>
                <div class="text-sm text-gray-600 mb-1">${act.expedientes_cobranzas.descripcion_caso}</div>
                <div class="font-semibold text-gray-800">${act.tipo_actuacion}</div>
                <div class="text-sm text-gray-600 mt-1">${act.descripcion}</div>
                ${act.archivo_url ? `<a href="${act.archivo_url}" target="_blank" class="text-blue-600 text-sm hover:underline mt-1 inline-block">📎 Ver documento</a>` : ''}
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error al cargar actuaciones:', error);
        document.getElementById('listaActuaciones').innerHTML = '<p class="text-red-500 text-center py-8">Error al cargar actuaciones</p>';
      }
    }

    // Suscribirse a cambios en tiempo real
    function suscribirCambios() {
      supabase
        .channel('cambios-actuaciones')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'actuaciones_cobranzas', filter: `usuario_id=eq.${usuarioActual.id}` },
          () => cargarActuaciones()
        )
        .subscribe();
    }

    // Limpiar formulario
    function limpiarFormulario() {
      document.getElementById('actuacionForm').reset();
      document.getElementById('expedienteExistente').disabled = false;
      document.getElementById('camposNuevoExpediente').classList.add('hidden');
      document.getElementById('historialExpediente').classList.add('hidden');
      document.getElementById('fechaActuacion').valueAsDate = new Date();
    }
  </script>
</body>
</html>
