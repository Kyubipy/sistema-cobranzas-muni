<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Jefe - Cobranzas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100">
  
  <!-- Header con usuario y cerrar sesi√≥n -->
  <div class="bg-gradient-to-r from-purple-700 to-purple-900 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold">üëî Panel del Jefe de Cobranzas</h1>
          <p class="text-purple-200 mt-1">Municipalidad de Asunci√≥n - Reporte en Tiempo Real</p>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right bg-white/10 px-4 py-2 rounded-lg">
            <p class="text-sm font-semibold">üë§ <span id="nombreUsuarioHeader"></span></p>
            <p class="text-xs text-purple-200">Jefe de Cobranzas</p>
          </div>
          <button onclick="cerrarSesion()" class="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
            <span>üö™</span>
            <span class="hidden sm:inline">Salir</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="app">
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Cargando datos...</p>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Supabase
    const SUPABASE_URL = 'https://wyxrtqudbjbwwlmqlrbc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eHJ0cXVkYmpid3dsbXFscmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTc2ODcsImV4cCI6MjA3Mzg3MzY4N30.vV0m-2D9Hod6t3CwW9ggFlgmMewlF0SaeuC2horX8fs';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variables globales
    let expedientes = [];
    let actuaciones = [];
    let abogadosFiltro = [];
    let filtroAbogado = 'Todos';
    let filtroTexto = '';
    let cargando = true;
    let usuarioActual = null;

    // Funci√≥n para cerrar sesi√≥n
    function cerrarSesion() {
      if (confirm('¬øEst√°s seguro que quer√©s cerrar sesi√≥n?')) {
        localStorage.removeItem('usuarioActual');
        window.location.href = 'index.html';
      }
    }

    // Inicializar
    async function init() {
      console.log('Iniciando aplicaci√≥n...');
      
      // Verificar si hay usuario logueado
      const usuarioGuardado = localStorage.getItem('usuarioActual');
      if (!usuarioGuardado) {
        window.location.href = 'index.html';
        return;
      }

      usuarioActual = JSON.parse(usuarioGuardado);
      
      // Verificar que sea jefe
      if (usuarioActual.rol !== 'jefe') {
        alert('Acceso no autorizado. Esta secci√≥n es solo para supervisores.');
        localStorage.removeItem('usuarioActual');
        window.location.href = 'index.html';
        return;
      }

      // Mostrar nombre en header
      document.getElementById('nombreUsuarioHeader').textContent = usuarioActual.nombre_completo;

      try {
        await cargarTodosDatos();
        renderApp();
        suscribirTiempoReal();
        console.log('Aplicaci√≥n iniciada correctamente');
      } catch (error) {
        console.error('Error en init:', error);
        document.getElementById('app').innerHTML = `
          <div class="min-h-screen flex items-center justify-center">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded max-w-md">
              <p class="font-bold">Error al cargar la aplicaci√≥n</p>
              <p class="text-sm">${error.message}</p>
            </div>
          </div>
        `;
      }
    }

    // Cargar todos los expedientes y actuaciones
    async function cargarTodosDatos() {
      console.log('Cargando datos...');
      try {
        // Cargar expedientes
        const { data: exps, error: expError } = await supabase
          .from('expedientes_cobranzas')
          .select('*')
          .order('fecha_creacion', { ascending: false });
        
        if (expError) {
          console.error('Error cargando expedientes:', expError);
          throw expError;
        }
        
        expedientes = exps || [];
        console.log('Expedientes cargados:', expedientes.length);

        // Obtener lista de abogados √∫nicos
        abogadosFiltro = ['Todos', ...new Set(expedientes.map(e => e.abogado_responsable))];

        // Cargar actuaciones
        if (expedientes.length > 0) {
          const { data: acts, error: actError } = await supabase
            .from('actuaciones_cobranzas')
            .select('*')
            .order('fecha_actuacion', { ascending: false });
          
          if (actError) {
            console.error('Error cargando actuaciones:', actError);
            throw actError;
          }
          
          actuaciones = acts || [];
          console.log('Actuaciones cargadas:', actuaciones.length);
        } else {
          actuaciones = [];
        }

        cargando = false;
      } catch (error) {
        console.error('Error en cargarTodosDatos:', error);
        cargando = false;
        throw error;
      }
    }

    // Suscripci√≥n tiempo real
    function suscribirTiempoReal() {
      console.log('Suscribiendo a tiempo real...');
      
      supabase
        .channel('jefe_channel')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'expedientes_cobranzas' },
          (payload) => {
            console.log('Cambio en expedientes:', payload);
            cargarTodosDatos().then(() => {
              if (!cargando) renderReporte();
            });
          }
        )
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'actuaciones_cobranzas' },
          (payload) => {
            console.log('Cambio en actuaciones:', payload);
            cargarTodosDatos().then(() => {
              if (!cargando) renderReporte();
            });
          }
        )
        .subscribe((status) => {
          console.log('Estado de suscripci√≥n:', status);
        });
    }

    function filtrarAbogado(abogado) {
      filtroAbogado = abogado;
      renderReporte();
    }

    function buscarTexto() {
      const input = document.getElementById('busqueda');
      if (input) {
        filtroTexto = input.value.toLowerCase();
        renderReporte();
      }
    }

    function renderApp() {
      console.log('Renderizando app...');
      const app = document.getElementById('app');
      if (!app) {
        console.error('No se encontr√≥ el elemento app');
        return;
      }

      app.innerHTML = `
        <div class="min-h-screen">
          <!-- Contenido -->
          <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="contenido"></div>
          </div>
        </div>
      `;

      setTimeout(() => {
        renderReporte();
      }, 100);
    }

    function renderReporte() {
      console.log('Renderizando reporte...');
      const contenido = document.getElementById('contenido');
      if (!contenido) {
        console.error('No se encontr√≥ el elemento contenido');
        return;
      }

      if (cargando) {
        contenido.innerHTML = `
          <div class="bg-white rounded-xl shadow-lg p-12 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Cargando datos...</p>
          </div>
        `;
        return;
      }

      // Filtrar expedientes
      let expedientesFiltrados = expedientes;
      
      if (filtroAbogado !== 'Todos') {
        expedientesFiltrados = expedientesFiltrados.filter(e => e.abogado_responsable === filtroAbogado);
      }

      if (filtroTexto) {
        expedientesFiltrados = expedientesFiltrados.filter(e => 
          e.num_expediente.toLowerCase().includes(filtroTexto) ||
          e.caratula.toLowerCase().includes(filtroTexto) ||
          e.anio.includes(filtroTexto)
        );
      }

      // Agrupar por abogado
      const porAbogado = {};
      expedientesFiltrados.forEach(exp => {
        if (!porAbogado[exp.abogado_responsable]) {
          porAbogado[exp.abogado_responsable] = [];
        }
        porAbogado[exp.abogado_responsable].push(exp);
      });

      // Calcular estad√≠sticas globales
      const totalExpedientes = expedientesFiltrados.length;
      const totalActuaciones = actuaciones.filter(a => 
        expedientesFiltrados.some(e => e.id === a.expediente_cobranza_id)
      ).length;
      const montoTotal = expedientesFiltrados
        .filter(e => e.tiene_monto)
        .reduce((sum, e) => sum + (parseFloat(e.monto) || 0), 0);

      contenido.innerHTML = `
        <div class="space-y-6">
          
          <!-- Filtros y b√∫squeda -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">üîç Buscar:</label>
                <input type="text" id="busqueda" 
                  onkeyup="buscarTexto()"
                  value="${filtroTexto}"
                  placeholder="N¬∞ expediente, car√°tula, a√±o..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">üë§ Filtrar por Abogado:</label>
                <select onchange="filtrarAbogado(this.value)" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white">
                  ${abogadosFiltro.map(a => `
                    <option value="${a}" ${filtroAbogado === a ? 'selected' : ''}>
                      ${a === 'Todos' ? 'üë• Todos los abogados' : 'üë§ ' + a}
                    </option>
                  `).join('')}
                </select>
              </div>
            </div>
            
            <!-- Botones de exportaci√≥n -->
            <div class="flex gap-3">
              <button onclick="exportarExcel()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                <span>üìä</span> Exportar a Excel
              </button>
              <button onclick="exportarCSV()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                <span>üì•</span> Exportar CSV
              </button>
            </div>
          </div>

          <!-- Estad√≠sticas Globales -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-lg shadow-lg">
              <p class="text-sm font-semibold opacity-90">üë• Abogados Activos</p>
              <p class="text-4xl font-bold mt-2">${Object.keys(porAbogado).length}</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-lg shadow-lg">
              <p class="text-sm font-semibold opacity-90">üìÇ Total Expedientes</p>
              <p class="text-4xl font-bold mt-2">${totalExpedientes}</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-5 rounded-lg shadow-lg">
              <p class="text-sm font-semibold opacity-90">üìù Total Actuaciones</p>
              <p class="text-4xl font-bold mt-2">${totalActuaciones}</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-5 rounded-lg shadow-lg">
              <p class="text-sm font-semibold opacity-90">üí∞ Monto Total</p>
              <p class="text-2xl font-bold mt-2">‚Ç≤ ${montoTotal.toLocaleString('es-PY')}</p>
            </div>
          </div>

          <!-- Reporte Detallado por Abogado -->
          <div class="space-y-8">
            ${Object.keys(porAbogado).length === 0 ? `
              <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                <p class="text-xl text-gray-500">üî≠ No hay expedientes registrados</p>
                <p class="text-sm text-gray-400 mt-2">Los expedientes aparecer√°n aqu√≠ autom√°ticamente</p>
              </div>
            ` : Object.keys(porAbogado).map(abogado => {
              const expsAbogado = porAbogado[abogado];
              const actsAbogado = actuaciones.filter(a => 
                expsAbogado.some(e => e.id === a.expediente_cobranza_id)
              );
              const montoAbogado = expsAbogado
                .filter(e => e.tiene_monto)
                .reduce((sum, e) => sum + (parseFloat(e.monto) || 0), 0);

              return `
                <div class="bg-white rounded-xl shadow-xl overflow-hidden border-t-4 border-indigo-600">
                  
                  <!-- Header del Abogado -->
                  <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white p-6">
                    <div class="flex justify-between items-center">
                      <div>
                        <h2 class="text-2xl font-bold">üë§ ${abogado}</h2>
                        <p class="text-indigo-200 mt-1">
                          ${expsAbogado.length} expediente${expsAbogado.length !== 1 ? 's' : ''} ‚Ä¢ 
                          ${actsAbogado.length} actuaci√≥n${actsAbogado.length !== 1 ? 'es' : ''}
                        </p>
                      </div>
                      <div class="text-right">
                        <p class="text-sm text-indigo-200">Monto Total</p>
                        <p class="text-2xl font-bold">‚Ç≤ ${montoAbogado.toLocaleString('es-PY')}</p>
                      </div>
                    </div>
                  </div>

                  <!-- Expedientes del Abogado -->
                  <div class="p-6 space-y-6">
                    ${expsAbogado.map((exp, expIndex) => {
                      const actExp = actuaciones.filter(a => a.expediente_cobranza_id === exp.id)
                        .sort((a, b) => new Date(b.fecha_actuacion) - new Date(a.fecha_actuacion));

                      return `
                        <div class="border-2 border-gray-200 rounded-lg p-5 bg-gradient-to-r from-gray-50 to-white hover:shadow-lg transition-shadow">
                          
                          <!-- Cabecera del Expediente -->
                          <div class="flex justify-between items-start mb-4 pb-4 border-b-2 border-gray-200">
                            <div class="flex-1">
                              <div class="flex items-center gap-3 mb-2">
                                <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-3 py-1 rounded-full">
                                  Expediente #${expIndex + 1}
                                </span>
                                <h3 class="text-xl font-bold text-gray-900">
                                  üìÇ Expte. ${exp.num_expediente}/${exp.anio}
                                </h3>
                              </div>
                              <p class="text-gray-700 font-semibold text-lg">${exp.caratula}</p>
                              ${exp.tiene_monto && exp.monto > 0 ? `
                                <p class="text-green-700 font-bold text-xl mt-2">
                                  üí∞ Monto: ‚Ç≤ ${parseFloat(exp.monto).toLocaleString('es-PY')}
                                </p>
                              ` : ''}
                            </div>
                            <div class="text-right">
                              <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-bold">
                                ${actExp.length} actuaci√≥n${actExp.length !== 1 ? 'es' : ''}
                              </span>
                              <p class="text-xs text-gray-500 mt-2">
                                Creado: ${new Date(exp.fecha_creacion).toLocaleDateString('es-PY')}
                              </p>
                            </div>
                          </div>

                          <!-- Listado de Actuaciones -->
                          <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                              <span class="text-xl">üìù</span>
                              HISTORIAL COMPLETO DE ACTUACIONES:
                            </h4>
                            
                            ${actExp.length === 0 ? `
                              <p class="text-gray-500 text-sm italic">Sin actuaciones registradas a√∫n</p>
                            ` : `
                              <div class="space-y-3">
                                ${actExp.map((act, actIndex) => `
                                  <div class="bg-white border-l-4 border-blue-500 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                                    
                                    <!-- Header de la actuaci√≥n -->
                                    <div class="flex justify-between items-start mb-3">
                                      <div class="flex items-center gap-2">
                                        <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">
                                          #${actExp.length - actIndex}
                                        </span>
                                        <span class="text-sm font-semibold text-blue-900">
                                          ${act.abogado}
                                        </span>
                                      </div>
                                      <span class="text-sm font-bold text-gray-700">
                                        üìÖ ${new Date(act.fecha_actuacion).toLocaleDateString('es-PY')}
                                      </span>
                                    </div>

                                    <!-- Descripci√≥n -->
                                    <div class="bg-blue-50 rounded p-3 mb-2">
                                      <p class="text-sm font-semibold text-blue-800 mb-1">üìã Descripci√≥n:</p>
                                      <p class="text-gray-900">${act.descripcion_actuacion}</p>
                                    </div>

                                    <!-- Observaciones -->
                                    ${act.observaciones ? `
                                      <div class="bg-yellow-50 rounded p-3 mb-2">
                                        <p class="text-sm font-semibold text-yellow-800 mb-1">üí≠ Observaciones:</p>
                                        <p class="text-gray-700 italic">${act.observaciones}</p>
                                      </div>
                                    ` : ''}

                                    <!-- Archivo -->
                                    ${act.archivo_nombre ? `
                                      <div class="flex items-center gap-2 bg-indigo-50 p-3 rounded">
                                        <span class="text-xl">üîé</span>
                                        <a href="${act.archivo_url}" target="_blank" rel="noopener noreferrer"
                                          class="flex-1 text-indigo-700 hover:text-indigo-900 font-semibold text-sm hover:underline">
                                          ${act.archivo_nombre}
                                        </a>
                                        <span class="text-xs text-indigo-600 font-bold">‚ÜóÔ∏è ABRIR</span>
                                      </div>
                                    ` : ''}

                                    <!-- Metadata -->
                                    <p class="text-xs text-gray-400 mt-3 text-right">
                                      ‚è∞ Registrado: ${new Date(act.fecha_registro).toLocaleString('es-PY')}
                                    </p>
                                  </div>
                                `).join('')}
                              </div>
                            `}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>

        </div>
      `;
    }

    // Exportar a Excel por abogado con actuaciones completas
    async function exportarExcel() {
      try {
        // Crear un objeto para agrupar por abogado
        const datosPorAbogado = {};

        // Agrupar expedientes por abogado
        expedientes.forEach(exp => {
          const abogado = exp.abogado_responsable;
          if (!datosPorAbogado[abogado]) {
            datosPorAbogado[abogado] = {
              expedientes: [],
              actuaciones: []
            };
          }
          datosPorAbogado[abogado].expedientes.push(exp);
        });

        // Agrupar actuaciones por abogado
        actuaciones.forEach(act => {
          const abogado = act.abogado;
          if (!datosPorAbogado[abogado]) {
            datosPorAbogado[abogado] = {
              expedientes: [],
              actuaciones: []
            };
          }
          datosPorAbogado[abogado].actuaciones.push(act);
        });

        // Crear workbook
        const wb = XLSX.utils.book_new();

        // Crear hoja de resumen
        const resumenData = [];
        resumenData.push(['RESUMEN GENERAL - SISTEMA DE COBRANZAS']);
        resumenData.push(['Municipalidad de Asunci√≥n']);
        resumenData.push(['Fecha de Reporte:', new Date().toLocaleDateString()]);
        resumenData.push([]);
        resumenData.push(['Abogado', 'Total Expedientes', 'Total Actuaciones', 'Monto Total (Gs.)']);

        Object.keys(datosPorAbogado).sort().forEach(abogado => {
          const datos = datosPorAbogado[abogado];
          const montoTotal = datos.expedientes
            .filter(e => e.tiene_monto)
            .reduce((sum, exp) => sum + (parseFloat(exp.monto) || 0), 0);
          resumenData.push([
            abogado,
            datos.expedientes.length,
            datos.actuaciones.length,
            montoTotal
          ]);
        });

        const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
        XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');

        // Crear una hoja por cada abogado
        Object.keys(datosPorAbogado).sort().forEach(abogado => {
          const datos = datosPorAbogado[abogado];
          const sheetData = [];

          sheetData.push([`ABOGADO: ${abogado}`]);
          sheetData.push([]);

          // Secci√≥n de Expedientes
          sheetData.push(['EXPEDIENTES']);
          sheetData.push(['N√∫mero', 'A√±o', 'Car√°tula', '√Årea', 'Tiene Monto', 'Monto (Gs.)', 'Fecha Creaci√≥n']);
          
          datos.expedientes.forEach(exp => {
            sheetData.push([
              exp.num_expediente,
              exp.anio,
              exp.caratula,
              exp.area || 'N/A',
              exp.tiene_monto ? 'S√≠' : 'No',
              exp.tiene_monto ? exp.monto : 0,
              new Date(exp.fecha_creacion).toLocaleDateString()
            ]);
          });

          sheetData.push([]);
          sheetData.push([]);

          // Secci√≥n de Actuaciones
          sheetData.push(['ACTUACIONES DETALLADAS']);
          sheetData.push(['Expediente', 'A√±o', 'Fecha Actuaci√≥n', 'Descripci√≥n', 'Observaciones', 'Tiene Archivo', 'Fecha Registro']);
          
          datos.actuaciones.forEach(act => {
            // Buscar expediente relacionado
            const exp = expedientes.find(e => e.id === act.expediente_cobranza_id);
            sheetData.push([
              exp ? exp.num_expediente : 'N/A',
              exp ? exp.anio : 'N/A',
              new Date(act.fecha_actuacion).toLocaleDateString(),
              act.descripcion_actuacion,
              act.observaciones || '',
              act.archivo_url ? 'S√≠' : 'No',
              new Date(act.fecha_registro).toLocaleString()
            ]);
          });

          // Nombre de la hoja (m√°ximo 31 caracteres)
          let nombreHoja = abogado.substring(0, 31);
          const ws = XLSX.utils.aoa_to_sheet(sheetData);
          XLSX.utils.book_append_sheet(wb, ws, nombreHoja);
        });

        // Crear hoja con todas las actuaciones detalladas
        const todasActuaciones = [];
        todasActuaciones.push(['TODAS LAS ACTUACIONES']);
        todasActuaciones.push(['Abogado', 'Expediente', 'A√±o', 'Car√°tula', 'Fecha Actuaci√≥n', 'Descripci√≥n', 'Observaciones', '√Årea', 'Monto (Gs.)', 'Archivo']);

        actuaciones.forEach(act => {
          const exp = expedientes.find(e => e.id === act.expediente_cobranza_id);
          todasActuaciones.push([
            act.abogado,
            exp ? exp.num_expediente : 'N/A',
            exp ? exp.anio : 'N/A',
            exp ? exp.caratula : 'N/A',
            new Date(act.fecha_actuacion).toLocaleDateString(),
            act.descripcion_actuacion,
            act.observaciones || '',
            exp ? exp.area : 'N/A',
            exp && exp.tiene_monto ? exp.monto : 0,
            act.archivo_url ? 'S√≠' : 'No'
          ]);
        });

        const wsTodasActuaciones = XLSX.utils.aoa_to_sheet(todasActuaciones);
        XLSX.utils.book_append_sheet(wb, wsTodasActuaciones, 'Todas las Actuaciones');

        // Descargar archivo
        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Reporte_Cobranzas_Completo_${fecha}.xlsx`);

        alert('‚úÖ Archivo Excel generado exitosamente');

      } catch (error) {
        console.error('Error al exportar Excel:', error);
        alert('‚ùå Error al exportar a Excel: ' + error.message);
      }
    }

    // Exportar CSV (funci√≥n original)
    async function exportarCSV() {
      try {
        // Convertir a CSV
        const csv = [
          ['Abogado', 'Expediente', 'A√±o', 'Car√°tula', 'Fecha Actuaci√≥n', 'Tipo', 'Descripci√≥n', 'Monto'].join(','),
          ...actuaciones.map(act => {
            const exp = expedientes.find(e => e.id === act.expediente_cobranza_id);
            return [
              act.abogado,
              exp ? exp.num_expediente : 'N/A',
              exp ? exp.anio : 'N/A',
              exp ? exp.caratula.replace(/,/g, ';') : 'N/A',
              act.fecha_actuacion,
              act.tipo_actuacion || 'General',
              act.descripcion_actuacion.replace(/,/g, ';'),
              exp && exp.tiene_monto ? exp.monto : 0
            ].join(',');
          })
        ].join('\n');

        // Descargar
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reporte_cobranzas_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        alert('‚úÖ Archivo CSV exportado exitosamente');
      } catch (error) {
        console.error('Error al exportar CSV:', error);
        alert('‚ùå Error al exportar datos: ' + error.message);
      }
    }

    // Esperar a que el DOM est√© completamente cargado
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(init, 200);
      });
    } else {
      setTimeout(init, 200);
    }
  </script>
</body>
</html>
