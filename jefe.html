<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Jefe - Cobranzas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="app">
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Cargando datos...</p>
      </div>
    </div>
  </div>

  <script>
    // Configuración de Supabase
    const SUPABASE_URL = 'https://wyxrtqudbjbwwlmqlrbc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eHJ0cXVkYmpid3dsbXFscmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTc2ODcsImV4cCI6MjA3Mzg3MzY4N30.vV0m-2D9Hod6t3CwW9ggFlgmMewlF0SaeuC2horX8fs';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variables globales
    let expedientes = [];
    let actuaciones = [];
    let abogadosFiltro = [];
    let filtroAbogado = 'Todos';
    let filtroTexto = '';
    let cargando = true;

    // Inicializar
    async function init() {
      console.log('Iniciando aplicación...');
      
      // Verificar si hay usuario logueado
      const usuarioGuardado = localStorage.getItem('usuarioActual');
      if (!usuarioGuardado) {
        window.location.href = 'index.html';
        return;
      }

      const usuarioActual = JSON.parse(usuarioGuardado);
      
      // Verificar que sea jefe
      if (usuarioActual.rol !== 'jefe') {
        alert('Acceso no autorizado');
        localStorage.removeItem('usuarioActual');
        window.location.href = 'index.html';
        return;
      }

      try {
        await cargarTodosDatos();
        renderApp();
        suscribirTiempoReal();
        console.log('Aplicación iniciada correctamente');
      } catch (error) {
        console.error('Error en init:', error);
        document.getElementById('app').innerHTML = `
          <div class="min-h-screen flex items-center justify-center">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded max-w-md">
              <p class="font-bold">Error al cargar la aplicación</p>
              <p class="text-sm">${error.message}</p>
            </div>
          </div>
        `;
      }
    }

    // Cargar todos los expedientes y actuaciones
    async function cargarTodosDatos() {
      console.log('Cargando datos...');
      try {
        // Cargar expedientes
        const { data: exps, error: expError } = await supabase
          .from('expedientes_cobranzas')
          .select('*')
          .order('fecha_creacion', { ascending: false });
        
        if (expError) {
          console.error('Error cargando expedientes:', expError);
          throw expError;
        }
        
        expedientes = exps || [];
        console.log('Expedientes cargados:', expedientes.length);

        // Obtener lista de abogados únicos
        abogadosFiltro = ['Todos', ...new Set(expedientes.map(e => e.abogado_responsable))];

        // Cargar actuaciones
        if (expedientes.length > 0) {
          const { data: acts, error: actError } = await supabase
            .from('actuaciones_cobranzas')
            .select('*')
            .order('fecha_actuacion', { ascending: false });
          
          if (actError) {
            console.error('Error cargando actuaciones:', actError);
            throw actError;
          }
          
          actuaciones = acts || [];
          console.log('Actuaciones cargadas:', actuaciones.length);
        } else {
          actuaciones = [];
        }

        cargando = false;
      } catch (error) {
        console.error('Error en cargarTodosDatos:', error);
        cargando = false;
        throw error;
      }
    }

    // Suscripción tiempo real
    function suscribirTiempoReal() {
      console.log('Suscribiendo a tiempo real...');
      
      supabase
        .channel('jefe_channel')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'expedientes_cobranzas' },
          (payload) => {
            console.log('Cambio en expedientes:', payload);
            cargarTodosDatos().then(() => {
              if (!cargando) renderReporte();
            });
          }
        )
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'actuaciones_cobranzas' },
          (payload) => {
            console.log('Cambio en actuaciones:', payload);
            cargarTodosDatos().then(() => {
              if (!cargando) renderReporte();
            });
          }
        )
        .subscribe((status) => {
          console.log('Estado de suscripción:', status);
        });
    }

    function cerrarSesion() {
      if (confirm('¿Estás seguro que querés cerrar sesión?')) {
        localStorage.removeItem('usuarioActual');
        window.location.href = 'index.html';
      }
    }

    function filtrarAbogado(abogado) {
      filtroAbogado = abogado;
      renderReporte();
    }

    function buscarTexto() {
      const input = document.getElementById('busqueda');
      if (input) {
        filtroTexto = input.value.toLowerCase();
        renderReporte();
      }
    }

    function exportarExcel() {
      try {
        const wb = XLSX.utils.book_new();
        
        // Filtrar expedientes según filtros actuales
        let expedientesFiltrados = expedientes;
        
        if (filtroAbogado !== 'Todos') {
          expedientesFiltrados = expedientesFiltrados.filter(e => e.abogado_responsable === filtroAbogado);
        }

        if (filtroTexto) {
          expedientesFiltrados = expedientesFiltrados.filter(e => 
            e.num_expediente.toLowerCase().includes(filtroTexto) ||
            e.caratula.toLowerCase().includes(filtroTexto) ||
            e.anio.includes(filtroTexto)
          );
        }

        // Agrupar por abogado
        const porAbogado = {};
        expedientesFiltrados.forEach(exp => {
          if (!porAbogado[exp.abogado_responsable]) {
            porAbogado[exp.abogado_responsable] = [];
          }
          porAbogado[exp.abogado_responsable].push(exp);
        });

        // Crear hoja por cada abogado
        Object.keys(porAbogado).forEach(abogado => {
          const expsAbogado = porAbogado[abogado];
          const datos = [];

          expsAbogado.forEach(exp => {
            const actExp = actuaciones.filter(a => a.expediente_cobranza_id === exp.id)
              .sort((a, b) => new Date(b.fecha_actuacion) - new Date(a.fecha_actuacion));

            // Fila del expediente
            datos.push({
              'EXPEDIENTE': `${exp.num_expediente}/${exp.anio}`,
              'CARÁTULA': exp.caratula,
              'JUZGADO': exp.juzgado || '',
              'TURNO': exp.turno || '',
              'SECRETARÍA': exp.secretaria || '',
              'MONTO': exp.tiene_monto && exp.monto > 0 ? `₲ ${parseFloat(exp.monto).toLocaleString('es-PY')}` : '',
              'FECHA CREACIÓN': new Date(exp.fecha_creacion).toLocaleDateString('es-PY'),
              'ACTUACIONES': actExp.length,
              'TIPO': 'EXPEDIENTE',
              'FECHA ACTUACIÓN': '',
              'DESCRIPCIÓN': '',
              'OBSERVACIONES': '',
              'ARCHIVO': ''
            });

            // Filas de actuaciones
            actExp.forEach((act, index) => {
              datos.push({
                'EXPEDIENTE': '',
                'CARÁTULA': '',
                'JUZGADO': '',
                'TURNO': '',
                'SECRETARÍA': '',
                'MONTO': '',
                'FECHA CREACIÓN': '',
                'ACTUACIONES': `#${actExp.length - index}`,
                'TIPO': 'ACTUACIÓN',
                'FECHA ACTUACIÓN': new Date(act.fecha_actuacion).toLocaleDateString('es-PY'),
                'DESCRIPCIÓN': act.descripcion_actuacion,
                'OBSERVACIONES': act.observaciones || '',
                'ARCHIVO': act.archivo_nombre && act.archivo_url ? 
                  { text: act.archivo_nombre, hyperlink: act.archivo_url } : 
                  ''
              });
            });

            // Línea vacía entre expedientes
            datos.push({
              'EXPEDIENTE': '',
              'CARÁTULA': '',
              'JUZGADO': '',
              'TURNO': '',
              'SECRETARÍA': '',
              'MONTO': '',
              'FECHA CREACIÓN': '',
              'ACTUACIONES': '',
              'TIPO': '',
              'FECHA ACTUACIÓN': '',
              'DESCRIPCIÓN': '',
              'OBSERVACIONES': '',
              'ARCHIVO': ''
            });
          });

          const ws = XLSX.utils.json_to_sheet(datos);
          
          // Convertir URLs en hyperlinks clickeables
          const range = XLSX.utils.decode_range(ws['!ref']);
          for (let R = range.s.r; R <= range.e.r; ++R) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: 12 }); // Columna ARCHIVO (índice 12)
            const cell = ws[cellAddress];
            
            if (cell && cell.v && typeof cell.v === 'object' && cell.v.hyperlink) {
              // Crear hyperlink en Excel
              cell.l = { Target: cell.v.hyperlink, Tooltip: "Click para abrir archivo" };
              cell.v = cell.v.text;
              cell.t = 's';
              
              // Estilo azul y subrayado para el link
              if (!cell.s) cell.s = {};
              cell.s.font = { color: { rgb: "0563C1" }, underline: true };
            }
          }
          
          // Ajustar anchos de columnas
          ws['!cols'] = [
            { wch: 15 },  // EXPEDIENTE
            { wch: 40 },  // CARÁTULA
            { wch: 25 },  // JUZGADO
            { wch: 10 },  // TURNO
            { wch: 15 },  // SECRETARÍA
            { wch: 15 },  // MONTO
            { wch: 12 },  // FECHA CREACIÓN
            { wch: 10 },  // ACTUACIONES
            { wch: 12 },  // TIPO
            { wch: 15 },  // FECHA ACTUACIÓN
            { wch: 50 },  // DESCRIPCIÓN
            { wch: 30 },  // OBSERVACIONES
            { wch: 30 }   // ARCHIVO (clickeable)
          ];

          XLSX.utils.book_append_sheet(wb, ws, abogado.substring(0, 31));
        });

        // Descargar
        const fecha = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `Reporte_Cobranzas_${fecha}.xlsx`);
        
      } catch (error) {
        console.error('Error exportando:', error);
        alert('Error al exportar a Excel: ' + error.message);
      }
    }

    function renderApp() {
      console.log('Renderizando app...');
      const app = document.getElementById('app');
      if (!app) {
        console.error('No se encontró el elemento app');
        return;
      }

      const usuarioGuardado = localStorage.getItem('usuarioActual');
      const usuario = usuarioGuardado ? JSON.parse(usuarioGuardado) : { nombre_completo: 'Jefe' };

      app.innerHTML = `
        <div class="min-h-screen">
          <!-- Header -->
          <div class="bg-gradient-to-r from-purple-700 to-purple-900 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
              <div class="flex justify-between items-center">
                <div>
                  <h1 class="text-3xl font-bold">👔 Panel del Jefe de Cobranzas</h1>
                  <p class="text-purple-200 mt-1">Municipalidad de Asunción - Reporte en Tiempo Real</p>
                </div>
                <div class="flex items-center gap-4">
                  <div class="text-right bg-white/10 px-4 py-2 rounded-lg">
                    <p class="text-sm font-semibold">👤 ${usuario.nombre_completo}</p>
                    <p class="text-xs text-purple-200">Supervisor</p>
                  </div>
                  <button onclick="cerrarSesion()" class="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition">
                    <span>🚪</span>
                    <span class="hidden sm:inline">Salir</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Contenido -->
          <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="contenido"></div>
          </div>
        </div>
      `;

      setTimeout(() => {
        renderReporte();
      }, 100);
    }

    function renderReporte() {
      console.log('Renderizando reporte...');
      const contenido = document.getElementById('contenido');
      if (!contenido) {
        console.error('No se encontró el elemento contenido');
        return;
      }

      if (cargando) {
        contenido.innerHTML = `
          <div class="bg-white rounded-xl shadow-lg p-12 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Cargando datos...</p>
          </div>
        `;
        return;
      }

      // Filtrar expedientes
      let expedientesFiltrados = expedientes;
      
      if (filtroAbogado !== 'Todos') {
        expedientesFiltrados = expedientesFiltrados.filter(e => e.abogado_responsable === filtroAbogado);
      }

      if (filtroTexto) {
        expedientesFiltrados = expedientesFiltrados.filter(e => 
          e.num_expediente.toLowerCase().includes(filtroTexto) ||
          e.caratula.toLowerCase().includes(filtroTexto) ||
          e.anio.includes(filtroTexto)
        );
      }

      // Agrupar por abogado
      const porAbogado = {};
      expedientesFiltrados.forEach(exp => {
        if (!porAbogado[exp.abogado_responsable]) {
          porAbogado[exp.abogado_responsable] = [];
        }
        porAbogado[exp.abogado_responsable].push(exp);
      });

      // Calcular estadísticas globales
      const totalExpedientes = expedientesFiltrados.length;
      const totalActuaciones = actuaciones.filter(a => 
        expedientesFiltrados.some(e => e.id === a.expediente_cobranza_id)
      ).length;
      const montoTotal = expedientesFiltrados
        .filter(e => e.tiene_monto)
        .reduce((sum, e) => sum + (parseFloat(e.monto) || 0), 0);

      contenido.innerHTML = `
        <div class="space-y-6">
          
          <!-- Filtros y búsqueda -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">🔍 Buscar:</label>
                <input type="text" id="busqueda" 
                  onkeyup="buscarTexto()"
                  value="${filtroTexto}"
                  placeholder="N° expediente, carátula, año..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">👤 Filtrar por Abogado:</label>
                <select onchange="filtrarAbogado(this.value)" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white">
                  ${abogadosFiltro.map(a => `
                    <option value="${a}" ${filtroAbogado === a ? 'selected' : ''}>
                      ${a === 'Todos' ? '👥 Todos los abogados' : '👤 ' + a}
                    </option>
                  `).join('')}
                </select>
              </div>
              <div class="flex items-end">
                <button onclick="exportarExcel()" 
                  class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                  📊 Exportar a Excel
                </button>
              </div>
            </div>
          </div>

          <!-- Estadísticas Globales -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-lg shadow-lg">
              <p class="text-sm font-semibold opacity-90">👥 Abogados Activos</p>
              <p class="text-4xl font-bold mt-2">${Object.keys(porAbogado).length}</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-lg shadow-lg">
              <p class="text-sm font-semibold opacity-90">📂 Total Expedientes</p>
              <p class="text-4xl font-bold mt-2">${totalExpedientes}</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-5 rounded-lg shadow-lg">
              <p class="text-sm font-semibold opacity-90">📝 Total Actuaciones</p>
              <p class="text-4xl font-bold mt-2">${totalActuaciones}</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-5 rounded-lg shadow-lg">
              <p class="text-sm font-semibold opacity-90">💰 Monto Total</p>
              <p class="text-2xl font-bold mt-2">₲ ${montoTotal.toLocaleString('es-PY')}</p>
            </div>
          </div>

          <!-- Reporte Detallado por Abogado -->
          <div class="space-y-8">
            ${Object.keys(porAbogado).length === 0 ? `
              <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                <p class="text-xl text-gray-500">🔭 No hay expedientes registrados</p>
                <p class="text-sm text-gray-400 mt-2">Los expedientes aparecerán aquí automáticamente</p>
              </div>
            ` : Object.keys(porAbogado).map(abogado => {
              const expsAbogado = porAbogado[abogado];
              const actsAbogado = actuaciones.filter(a => 
                expsAbogado.some(e => e.id === a.expediente_cobranza_id)
              );
              const montoAbogado = expsAbogado
                .filter(e => e.tiene_monto)
                .reduce((sum, e) => sum + (parseFloat(e.monto) || 0), 0);

              return `
                <div class="bg-white rounded-xl shadow-xl overflow-hidden border-t-4 border-indigo-600">
                  
                  <!-- Header del Abogado -->
                  <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white p-6">
                    <div class="flex justify-between items-center">
                      <div>
                        <h2 class="text-2xl font-bold">👤 ${abogado}</h2>
                        <p class="text-indigo-200 mt-1">
                          ${expsAbogado.length} expediente${expsAbogado.length !== 1 ? 's' : ''} • 
                          ${actsAbogado.length} actuación${actsAbogado.length !== 1 ? 'es' : ''}
                        </p>
                      </div>
                      <div class="text-right">
                        <p class="text-sm text-indigo-200">Monto Total</p>
                        <p class="text-2xl font-bold">₲ ${montoAbogado.toLocaleString('es-PY')}</p>
                      </div>
                    </div>
                  </div>

                  <!-- Expedientes del Abogado -->
                  <div class="p-6 space-y-6">
                    ${expsAbogado.map((exp, expIndex) => {
                      const actExp = actuaciones.filter(a => a.expediente_cobranza_id === exp.id)
                        .sort((a, b) => new Date(b.fecha_actuacion) - new Date(a.fecha_actuacion));

                      return `
                        <div class="border-2 border-gray-200 rounded-lg p-5 bg-gradient-to-r from-gray-50 to-white hover:shadow-lg transition-shadow">
                          
                          <!-- Cabecera del Expediente -->
                          <div class="flex justify-between items-start mb-4 pb-4 border-b-2 border-gray-200">
                            <div class="flex-1">
                              <div class="flex items-center gap-3 mb-2">
                                <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-3 py-1 rounded-full">
                                  Expediente #${expIndex + 1}
                                </span>
                                <h3 class="text-xl font-bold text-gray-900">
                                  📂 Expte. ${exp.num_expediente}/${exp.anio}
                                </h3>
                              </div>
                              <p class="text-gray-700 font-semibold text-lg mb-2">${exp.caratula}</p>
                              
                              ${exp.juzgado || exp.turno || exp.secretaria ? `
                                <div class="flex flex-wrap gap-2 mb-2">
                                  ${exp.juzgado ? `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">🏛️ ${exp.juzgado}</span>` : ''}
                                  ${exp.turno ? `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">🔄 ${exp.turno}</span>` : ''}
                                  ${exp.secretaria ? `<span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">📋 ${exp.secretaria}</span>` : ''}
                                </div>
                              ` : ''}
                              
                              ${exp.tiene_monto && exp.monto > 0 ? `
                                <p class="text-green-700 font-bold text-xl mt-2">
                                  💰 Monto: ₲ ${parseFloat(exp.monto).toLocaleString('es-PY')}
                                </p>
                              ` : ''}
                            </div>
                            <div class="text-right">
                              <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-bold">
                                ${actExp.length} actuación${actExp.length !== 1 ? 'es' : ''}
                              </span>
                              <p class="text-xs text-gray-500 mt-2">
                                Creado: ${new Date(exp.fecha_creacion).toLocaleDateString('es-PY')}
                              </p>
                            </div>
                          </div>

                          <!-- Listado de Actuaciones -->
                          <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                              <span class="text-xl">📝</span>
                              HISTORIAL COMPLETO DE ACTUACIONES:
                            </h4>
                            
                            ${actExp.length === 0 ? `
                              <p class="text-gray-500 text-sm italic">Sin actuaciones registradas aún</p>
                            ` : `
                              <div class="space-y-3">
                                ${actExp.map((act, actIndex) => `
                                  <div class="bg-white border-l-4 border-blue-500 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                                    
                                    <!-- Header de la actuación -->
                                    <div class="flex justify-between items-start mb-3">
                                      <div class="flex items-center gap-2">
                                        <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">
                                          #${actExp.length - actIndex}
                                        </span>
                                        <span class="text-sm font-semibold text-blue-900">
                                          ${act.abogado}
                                        </span>
                                      </div>
                                      <span class="text-sm font-bold text-gray-700">
                                        📅 ${new Date(act.fecha_actuacion).toLocaleDateString('es-PY')}
                                      </span>
                                    </div>

                                    <!-- Descripción -->
                                    <div class="bg-blue-50 rounded p-3 mb-2">
                                      <p class="text-sm font-semibold text-blue-800 mb-1">📋 Descripción:</p>
                                      <p class="text-gray-900">${act.descripcion_actuacion}</p>
                                    </div>

                                    <!-- Observaciones -->
                                    ${act.observaciones ? `
                                      <div class="bg-yellow-50 rounded p-3 mb-2">
                                        <p class="text-sm font-semibold text-yellow-800 mb-1">💭 Observaciones:</p>
                                        <p class="text-gray-700 italic">${act.observaciones}</p>
                                      </div>
                                    ` : ''}

                                    <!-- Archivo -->
                                    ${act.archivo_nombre ? `
                                      <div class="flex items-center gap-2 bg-indigo-50 p-3 rounded">
                                        <span class="text-xl">📎</span>
                                        <a href="${act.archivo_url}" target="_blank" rel="noopener noreferrer"
                                          class="flex-1 text-indigo-700 hover:text-indigo-900 font-semibold text-sm hover:underline">
                                          ${act.archivo_nombre}
                                        </a>
                                        <span class="text-xs text-indigo-600 font-bold">↗️ ABRIR</span>
                                      </div>
                                    ` : ''}

                                    <!-- Metadata -->
                                    <p class="text-xs text-gray-400 mt-3 text-right">
                                      ⏰ Registrado: ${new Date(act.fecha_registro).toLocaleString('es-PY')}
                                    </p>
                                  </div>
                                `).join('')}
                              </div>
                            `}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>

        </div>
      `;
    }

    // Esperar a que el DOM esté completamente cargado
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(init, 200);
      });
    } else {
      setTimeout(init, 200);
    }
  </script>
</body>
</html>
