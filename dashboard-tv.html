<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard TV - Sistema de Cobranzas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .slide-in {
      animation: slideIn 0.5s ease-out;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 min-h-screen overflow-hidden">
  
  <!-- Header -->
  <div class="bg-black/30 backdrop-blur-sm border-b border-white/20">
    <div class="container mx-auto px-8 py-6">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
            <span class="text-4xl">‚öñÔ∏è</span>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-white">Sistema de Cobranzas</h1>
            <p class="text-purple-200">Municipalidad de Asunci√≥n - Actuaciones en Tiempo Real</p>
          </div>
        </div>
        <div class="text-right">
          <div id="fecha" class="text-2xl font-bold text-white"></div>
          <div id="hora" class="text-xl text-purple-200"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Estad√≠sticas -->
  <div class="container mx-auto px-8 py-6">
    <div class="grid grid-cols-4 gap-6 mb-6">
      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-200 text-sm font-semibold mb-1">Total Expedientes</p>
            <p id="totalExpedientes" class="text-5xl font-bold text-white">0</p>
          </div>
          <span class="text-6xl">üìÇ</span>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-200 text-sm font-semibold mb-1">Actuaciones Hoy</p>
            <p id="actuacionesHoy" class="text-5xl font-bold text-white">0</p>
          </div>
          <span class="text-6xl">üìù</span>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-200 text-sm font-semibold mb-1">Esta Semana</p>
            <p id="actuacionesSemana" class="text-5xl font-bold text-white">0</p>
          </div>
          <span class="text-6xl">üìä</span>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-200 text-sm font-semibold mb-1">Abogados Activos</p>
            <p id="abogadosActivos" class="text-5xl font-bold text-white">0</p>
          </div>
          <span class="text-6xl">üë•</span>
        </div>
      </div>
    </div>

    <!-- Lista de actuaciones recientes -->
    <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
      <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
        <span>üî¥</span> Actuaciones Recientes (Live)
      </h2>
      <div id="listaActuaciones" class="space-y-3 max-h-[calc(100vh-400px)] overflow-y-auto pr-2">
        <p class="text-purple-200 text-center py-8">Cargando actuaciones...</p>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Supabase
    const supabaseUrl = 'https://nxdjnoctsuzuemxqkybf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54ZGpub2N0c3V6dWVteHFreWJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk3MjU0MDIsImV4cCI6MjA0NTMwMTQwMn0.9wre1y66Go2Z89sNM-wTSgeVB1-iiPN2gTFR5ctu30s';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Actualizar fecha y hora
    function actualizarFechaHora() {
      const ahora = new Date();
      const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('fecha').textContent = ahora.toLocaleDateString('es-PY', opciones);
      document.getElementById('hora').textContent = ahora.toLocaleTimeString('es-PY');
    }

    // Inicializar
    window.addEventListener('DOMContentLoaded', () => {
      actualizarFechaHora();
      setInterval(actualizarFechaHora, 1000);
      cargarDatos();
      suscribirCambios();
    });

    // Cargar estad√≠sticas y actuaciones
    async function cargarDatos() {
      try {
        // Cargar expedientes totales
        const { count: countExpedientes, error: errorExp } = await supabase
          .from('expedientes_cobranzas')
          .select('*', { count: 'exact', head: true });

        if (errorExp) throw errorExp;
        document.getElementById('totalExpedientes').textContent = countExpedientes || 0;

        // Cargar actuaciones de hoy
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const { count: countHoy, error: errorHoy } = await supabase
          .from('actuaciones_cobranzas')
          .select('*', { count: 'exact', head: true })
          .gte('fecha_actuacion', hoy.toISOString());

        if (errorHoy) throw errorHoy;
        document.getElementById('actuacionesHoy').textContent = countHoy || 0;

        // Cargar actuaciones de esta semana
        const inicioSemana = new Date();
        inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
        inicioSemana.setHours(0, 0, 0, 0);
        
        const { count: countSemana, error: errorSemana } = await supabase
          .from('actuaciones_cobranzas')
          .select('*', { count: 'exact', head: true })
          .gte('fecha_actuacion', inicioSemana.toISOString());

        if (errorSemana) throw errorSemana;
        document.getElementById('actuacionesSemana').textContent = countSemana || 0;

        // Cargar actuaciones recientes
        const { data: actuaciones, error: errorAct } = await supabase
          .from('actuaciones_cobranzas')
          .select(`
            *,
            expedientes_cobranzas (numero_expediente, descripcion_caso)
          `)
          .order('created_at', { ascending: false })
          .limit(10);

        if (errorAct) throw errorAct;

        // Contar abogados √∫nicos
        const abogadosUnicos = new Set(actuaciones.map(act => act.abogado));
        document.getElementById('abogadosActivos').textContent = abogadosUnicos.size;

        // Mostrar actuaciones
        mostrarActuaciones(actuaciones);

      } catch (error) {
        console.error('Error al cargar datos:', error);
      }
    }

    // Mostrar actuaciones
    function mostrarActuaciones(actuaciones) {
      const lista = document.getElementById('listaActuaciones');
      
      if (actuaciones.length === 0) {
        lista.innerHTML = '<p class="text-purple-200 text-center py-8">No hay actuaciones registradas a√∫n</p>';
        return;
      }

      lista.innerHTML = actuaciones.map((act, index) => {
        const esNuevo = index === 0; // Primera actuaci√≥n es la m√°s reciente
        const fecha = new Date(act.fecha_actuacion);
        const creado = new Date(act.created_at);
        const esHoy = fecha.toDateString() === new Date().toDateString();
        
        return `
          <div class="bg-white/20 backdrop-blur-sm border-l-4 ${esNuevo ? 'border-green-400' : 'border-purple-400'} rounded-r-xl p-4 ${esNuevo ? 'slide-in' : ''}">
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  ${esNuevo ? '<span class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">NUEVO</span>' : ''}
                  <span class="font-bold text-xl text-white">${act.expedientes_cobranzas.numero_expediente}</span>
                  <span class="text-purple-200">${fecha.toLocaleDateString()}</span>
                  ${esHoy ? '<span class="bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full">HOY</span>' : ''}
                </div>
                <div class="text-purple-100 mb-2">${act.expedientes_cobranzas.descripcion_caso}</div>
                <div class="flex items-center gap-3">
                  <span class="bg-purple-500 text-white px-3 py-1 rounded-full text-sm font-semibold">${act.tipo_actuacion}</span>
                  <span class="text-white font-medium">üë®‚Äç‚öñÔ∏è ${act.abogado}</span>
                </div>
                <div class="text-purple-200 mt-2 text-sm">${act.descripcion}</div>
              </div>
              <div class="text-right text-purple-200 text-sm">
                <div>${creado.toLocaleDateString()}</div>
                <div class="font-mono">${creado.toLocaleTimeString()}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Suscribirse a cambios en tiempo real
    function suscribirCambios() {
      supabase
        .channel('cambios-dashboard')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'actuaciones_cobranzas' },
          (payload) => {
            console.log('Cambio detectado:', payload);
            cargarDatos();
          }
        )
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'expedientes_cobranzas' },
          (payload) => {
            console.log('Cambio en expedientes:', payload);
            cargarDatos();
          }
        )
        .subscribe();
    }

    // Recargar datos cada 30 segundos (por si acaso)
    setInterval(() => {
      cargarDatos();
    }, 30000);
  </script>
</body>
</html>
